{% extends "inventory/base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Resumen de existencias, alertas y detalle por bodega{% endblock %}

{% block content %}

<div class="row g-3 mb-3">
  <div class="col-12 col-md-4">
    <div class="card card-soft">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="muted small">Productos con stock bajo</div>
            <div class="display-6 fw-bold mb-0">{{ low_stock_count }}</div>
          </div>
          <div class="rounded-circle d-flex align-items-center justify-content-center"
               style="width:52px;height:52px;background:rgba(239,68,68,.12);">
            <i class="bi bi-exclamation-triangle fs-4" style="color:#b91c1c;"></i>
          </div>
        </div>
        <div class="mt-2 small muted">Revisa productos por debajo del mínimo.</div>
      </div>
    </div>
  </div>
</div>

<div class="card card-soft mb-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="mb-0"><i class="bi bi-exclamation-diamond"></i> Productos con stock bajo</h5>
      {% if low_stock_count %}
        <span class="badge badge-danger-soft">Alerta</span>
      {% else %}
        <span class="badge badge-soft">OK</span>
      {% endif %}
    </div>

    {% if low_stock %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Código</th>
              <th>Producto</th>
              <th class="text-end">Stock total</th>
              <th class="text-end">Stock mínimo</th>
            </tr>
          </thead>
          <tbody>
            {% for item in low_stock %}
              <tr>
                <td class="fw-semibold">{{ item.product__sku }}</td>
                <td>{{ item.product__name }}</td>
                <td class="text-end">
                  <span class="badge badge-danger-soft">{{ item.total }}</span>
                </td>
                <td class="text-end">{{ item.product__min_stock }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-success mb-0">
        <i class="bi bi-check-circle"></i> No hay productos con stock por debajo del mínimo.
      </div>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="card card-soft">
      <div class="card-body">
        <h5 class="mb-3"><i class="bi bi-bar-chart"></i> Totales por producto</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Producto</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in totals %}
                <tr>
                  <td>{{ item.product__name }}</td>
                  <td class="text-end fw-semibold">{{ item.total }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="2" class="muted">Sin existencias.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card card-soft">
      <div class="card-body">
        <h5 class="mb-3"><i class="bi bi-building"></i> Detalle por bodega</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Bodega</th>
                <th>Producto</th>
                <th class="text-end">Cantidad</th>
              </tr>
            </thead>
            <tbody>
              {% for stock in stocks %}
                <tr>
                  <td class="fw-semibold">{{ stock.warehouse.name }}</td>
                  <td>{{ stock.product.name }}</td>
                  <td class="text-end">
                    {% if stock.product.min_stock and stock.quantity < stock.product.min_stock %}
                      <span class="badge badge-danger-soft">{{ stock.quantity }}</span>
                    {% else %}
                      <span class="badge badge-soft">{{ stock.quantity }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="3" class="muted">Aún no hay movimientos registrados.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
